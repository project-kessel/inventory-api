# Consumer Message Processing Failures

## Prerequisites

Remediations covered in this guide will require the following:
1) [zed cli](https://github.com/authzed/zed?tab=readme-ov-file#getting-started)
2) Access to running Inventory API pod logs
3) Access to a running container with Kafka CLI tools (covered in runbooks where needed)
4) Kafka connection information including bootstrap servers and authentication credentials (covered in runbooks where needed)

### Configuring Zed CLI

To install the `zed` CLI, refer to [Authzed's README](https://github.com/authzed/zed?tab=readme-ov-file#getting-started) for specific instructions based on your OS

In order to access SpiceDB using the `zed` cli, you'll need to configure a context for the SpiceDB endpoint. This will require a preshared token available in a Kubernetes secret on cluster.

To configure the context:

```shell
# capture the preshared key from spicedb-config secret
PSTK=$(oc get secret spicedb-config -o jsonpath='{.data.preshared_key}' | base64 -d)

# create the context with zed cli -- change ENV to the ENV you are targeting (stage, prod)
zed context set <ENV>-spicedb localhost:50051 $PSTK --insecure

# verify the context was created and is the current context
zed context list
```

To confirm the context is working:

```shell
# port-forward the spicedb service to your system
oc port-forward svc/kessel-relations-spicedb 50051:50051

# check the schema
zed schema read
```

The read command should dump out the entire SpiceDB schema. An error is provided if there are any connection issues or if no schema exists.


## Schema Related Issues

There are two known distinct reasons tuple creation could fail due to schema issues:
1) The schema definitions between Inventory API and Relations API are not in sync
2) The schema is valid but the tuple request values are malformed by Inventory API

### Inventory Consumer fails to Create/Modify a Relationship due to schema mismatch

**Example Error in Inventory API Logs**

```
msg=request failed: error creating tuple: rpc error: code = FailedPrecondition desc = error creating tuples: error writing relationships to SpiceDB: rpc error: code = FailedPrecondition desc = object definition `notifications/host` not found
```

**Reason**

The error `object definition "OBJECT" not found` indicates the schema loaded by SpiceDB does not contain a defintion for the tuple request. This is likely due to a mismatch between Inventory API and Relations API schema definitions

**Verify and Remediate**

You can verify if there is a schema mismatch one of two ways:

1) Check the loaded schema in Relations API for the object

```shell
zed schema read | grep <OBJECT>

# using the example error above
zed schema read | grep "notifications/host"
```

If nothing is returned, the loaded schema is missing the expected definition

2) Compare the loaded schema to the expected schema

The schema is deployed via App Interface and is visible in the [`spicedb-schema`](https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/resources/insights-common/kessel/kessel-spicedb-schema-configmap.yml?ref_type=heads) ConfigMap in cluster. The ConfigMap is generated by pulling from Github using a specifc commit hash. When comparing the loaded schema to the expected schema, the commit ref listed in App Interface should be used


```shell
# capture the commit ref in app interface
COMMIT_REF=<value-in-app-interface>

# capture the loaded schema in SpiceDB
TMPDIR=$(mktemp -d) && pushd $TMPDIR

oc port-forward svc/kessel-relations-spicedb 50051:50051

zed schema read > loaded-schema.zed

# capture the schema def from the configmap
oc get cm spicedb-schema -o json | jq -r '.data."schema.zed"' > configmap.zed

# download the production schema from git using the commit ref
curl -O https://raw.githubusercontent.com/RedHatInsights/rbac-config/${COMMIT_REF}/configs/prod/schemas/schema.zed

# compare the downloaded schema to configmap schema
zed schema diff schema.zed configmap.zed

# compare the downloaded schema to the loaded schema from SpiceDB
zed schema diff schema.zed loaded-schema.zed

# when the issue is wrapped up, you can clean up with
popd && rm -rf $TMPDIR
```

The output of the `zed schema diff` commands will have no output when they match. Any differences will be shown which indicates a schema mismatch

If the downloaded schema and configmap schema dont match:
* there is an issue with the deployed configmap and the configmap must be redeployed with the correct hash via App Interface

If the downloaded schema and configmap match but the loaded schema doesnt:
* SpiceDB has not properly loaded the configmap, restarting the Relations API pods should reload the configmap

If all schema definitions match and the expected object from the error log does not exist in any of them, its possible the schema defintion for Relations has not been updated yet for the resource, or its possible Inventory has created a malformed request. See [Inventory Consumer fails due to malformed Tuple request](#inventory-consumer-fails-due-to-malformed-tuple-request) on how to check Inventory schema definitions for issues.

### Inventory Consumer fails due to malformed Tuple request

**Example Error in Inventory API Logs**

```
msg=request failed: error creating tuple: rpc error: code = FailedPrecondition desc = error creating tuples: error writing relationships to SpiceDB: rpc error: code = FailedPrecondition desc = object definition `notifications/host` not found
```

**Reason**

The error `object definition "OBJECT" not found` indicates the schema loaded by SpiceDB does not contain a defintion for the tuple request. If after review of the schema's via the [above runbook](#inventory-consumer-fails-to-createmodify-a-relationship-due-to-schema-mismatch) confirms the schemas are properly updated, the issue may be a malformed tuple. Reviewing the Inventory schemas can confirm if the tuple type should be supported or not and whether there is a bug in Inventory code.

**Verify and Remediate**

Inventory resource schemas are defined for each resource type supported by Kessel. If the Inventory Consumer fails to create/modify tuples due to schema definition issues, and no issues are found with the Relations API schemas, its possible Inventory is somehow creating malformed tuple requests. A review of the schema definitions can confirm if a resource type and reporter type is supported.

The supported resource types can be found in the [schemas folder](https://github.com/project-kessel/inventory-api/tree/main/data/schema/resources)

Each resource contains a `config.yaml` file in the root of its directory that lists the supported reporter types in the `resource_reporters` section.

For example: The Kubernetes Cluster resource supports ACM, ACS, and OCM as reporter types [LINK](https://github.com/project-kessel/inventory-api/blob/main/data/schema/resources/k8s_cluster/config.yaml)

From the error above, `notifications/host` should reflect the format of `reporter_type/resource_type` where `reporter_type` can only be one of the listed `resource_reporters` defined in the schemas and `resource_type` correlates to the same value in the `config.yaml`

Using the same error example, the resource type `host` only supports the resource type `HBI` and therefore `notifications/host` would not be a valid tuple. This means Inventory has created an invalid tuple and there is likely a bug.

Tuple requests are generated based on messages consumed by the Inventory Consumer. To restore services, update the Inventory Consumers offset to skip the bad message allowing it to continue to process any messages in the queue after it.

To update the Offset:
1) Leverage the [ConsoleDot Kafka Debug process](https://inscope.corp.redhat.com/docs/default/component/consoledot-pages/services/kafka/#kafka-debug-pod) to spin up a pod with access to the Platform MQ Kafka cluster
2) Update the offset for the Inventory Consumer Group

```shell
# from the kafka debug pod
/opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server $BOOTSTRAP_SERVERS --command-config /opt/kafka/config/authed-kafka.properties --group inventory-consumer --reset-offsets --shift-by 1 --execute --topic outbox.event.kessel.tuples
```

The Inventory Consumer should move to the next message in the queue after completing and should continue processing as normal. Note, the `kafka-consumer-groups.sh` command generally expects the consumer to not be active in order to complete. It may be required to scale the deployment down to 0 replicas to complete this step. Consumer failures have a retry loop with backoff, executing the command in those waiting periods generally is sufficient.

If scaling down is needed: `oc scale -n kessel-prod --replicas 0 deployment/kessel-inventory-api`

Make sure to scale back up after executing the offset update

If the problem persists on subsequent messages, or if the failed object is supported based on Inventory schema definitions, but is not present in the Relations API schema definitions, there is likely a missing defintion that still needs to be added to the Relations schemas for the new resource type.

Either of these two situations will require a Kessel team members involvement.
